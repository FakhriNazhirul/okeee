<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Kopi Nusantara</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Backup styles jika CSS tidak load - SAMA PERSIS DENGAN YANG LAMA */
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 250px; background: #2c3e50; color: white; }
        .admin-main { flex: 1; padding: 20px; }
        .dashboard-content { max-width: 1200px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .stat-icon { width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-size: 24px; }
        .dashboard-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .btn { display: inline-block; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; }
        .btn-primary { background: #2ecc71; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; color: white; }
        .badge-coffee { background: #e74c3c; }
        .badge-non-coffee { background: #3498db; }
        .badge-makanan { background: #2ecc71; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .text-muted { color: #7f8c8d; }
        .empty-state { text-align: center; padding: 40px; }
        .table-responsive { overflow-x: auto; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .action-card { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; text-decoration: none; color: #333; transition: transform 0.3s; }
        .action-card:hover { transform: translateY(-5px); background: #e9ecef; }
        .action-card i { font-size: 24px; margin-bottom: 10px; display: block; color: #3498db; }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-coffee"></i> Kopi Nusantara</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/dashboard.html" class="active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="/admin/menu.html">
                    <i class="fas fa-utensils"></i> Kelola Menu
                </a>
                <a href="/admin/orders.html">
                    <i class="fas fa-shopping-cart"></i> Pesanan
                </a>
                <a href="/index.html" target="_blank">
                    <i class="fas fa-home"></i> Lihat Website
                </a>
                <a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="admin-main">
            <header class="admin-header">
                <h1>Dashboard Admin</h1>
                <div class="admin-user">
                    <span id="adminUsername">Admin</span>
                    <span class="badge badge-coffee">Admin</span>
                    <span id="apiStatus" style="margin-left: 10px; font-size: 12px; padding: 3px 8px; border-radius: 10px; background: #f39c12; color: white;">
                        <i class="fas fa-circle-notch fa-spin"></i> Loading...
                    </span>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Connection Status -->
                <div id="connectionStatus" style="display: none; background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px; border-left: 4px solid #dc3545;">
                    <strong><i class="fas fa-exclamation-triangle"></i> Koneksi Bermasalah:</strong>
                    <span id="errorMessage"></span>
                    <div style="margin-top: 10px;">
                        <button onclick="testConnection()" class="btn" style="background: #3498db; padding: 5px 10px; font-size: 12px;">
                            <i class="fas fa-redo"></i> Test Koneksi
                        </button>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #4CAF50;">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalMenu">0</h3>
                            <p>Total Menu</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #2196F3;">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCoffee">0</h3>
                            <p>Menu Coffee</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #FF9800;">
                            <i class="fas fa-glass-whiskey"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalNonCoffee">0</h3>
                            <p>Non-Coffee</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #9C27B0;">
                            <i class="fas fa-hamburger"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalFood">0</h3>
                            <p>Menu Makanan</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Menu Table -->
                <!-- <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Menu Terbaru</h2>
                        <a href="/admin/menu.html" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Tambah Menu
                        </a>
                    </div> -->
                    
                    <div id="menuLoading" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Memuat data menu...</p>
                    </div>
                    
                    <div id="menuTableContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table" id="recentMenuTable">
                                <thead>
                                    <tr>
                                        <th>Nama Menu</th>
                                        <th>Harga</th>
                                        <th>Kategori</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="menuTableBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="menuEmpty" class="empty-state" style="display: none;">
                        <i class="fas fa-utensils"></i>
                        <p>Belum ada data menu</p>
                        <a href="/admin/menu.html" class="btn btn-primary">Tambah Menu Pertama</a>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                    <div class="quick-actions">
                        <a href="/admin/menu.html" class="action-card">
                            <i class="fas fa-plus-circle"></i>
                            <span>Tambah Menu Baru</span>
                        </a>
                        <a href="/admin/orders.html" class="action-card">
                            <i class="fas fa-eye"></i>
                            <span>Lihat Pesanan</span>
                        </a>
                        <a href="/index.html" class="action-card" target="_blank">
                            <i class="fas fa-external-link-alt"></i>
                            <span>Lihat Frontend</span>
                        </a>
                        <a href="/admin/menu.html" class="action-card">
                            <i class="fas fa-edit"></i>
                            <span>Edit Menu</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript dengan PERBAIKAN untuk API Connection -->
    <!-- GANTI JavaScript dengan versi ini: -->
<script>
// ==================== KONFIGURASI ====================
const API_BASE_URL = ''; // Relative path

// ==================== FUNGSI UTILITY ====================
function updateApiStatus(status, message = '') {
    const statusEl = document.getElementById('apiStatus');
    
    if (status === 'online') {
        statusEl.innerHTML = '<i class="fas fa-check-circle"></i> Online';
        statusEl.style.background = '#28a745';
    } else if (status === 'offline') {
        statusEl.innerHTML = '<i class="fas fa-times-circle"></i> Offline';
        statusEl.style.background = '#dc3545';
    } else if (status === 'loading') {
        statusEl.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> ' + message;
        statusEl.style.background = '#f39c12';
    }
}

function showConnectionError(message) {
    const statusDiv = document.getElementById('connectionStatus');
    const errorMsg = document.getElementById('errorMessage');
    
    errorMsg.textContent = message;
    statusDiv.style.display = 'block';
}

function hideConnectionError() {
    document.getElementById('connectionStatus').style.display = 'none';
}

// ==================== FUNGSI TEST KONEKSI ====================
async function testConnection() {
    console.log('üß™ Testing connection...');
    updateApiStatus('loading', 'Testing...');
    
    try {
        // Test 1: API test endpoint
        const testResponse = await fetch('/api/test');
        console.log('API Test status:', testResponse.status);
        
        if (!testResponse.ok) {
            throw new Error(`API Test failed: ${testResponse.status}`);
        }
        
        const testData = await testResponse.json();
        console.log('API Test data:', testData);
        
        updateApiStatus('online');
        hideConnectionError();
        return true;
        
    } catch (error) {
        console.error('‚ùå Connection test failed:', error);
        showConnectionError(error.message);
        updateApiStatus('offline');
        return false;
    }
}

// ==================== FUNGSI LOAD STATISTIK ====================
async function loadStatistics() {
    console.log('üìä Loading statistics...');
    
    // Coba beberapa endpoint untuk statistik
    const endpoints = [
        '/api/menu/stats',
        '/api/menu-statistics',
        '/api/menu/count'
    ];
    
    let statsData = null;
    
    for (const endpoint of endpoints) {
        try {
            console.log(`Trying endpoint: ${endpoint}`);
            const response = await fetch(endpoint);
            
            if (response.ok) {
                const data = await response.json();
                console.log(`‚úÖ ${endpoint} success:`, data);
                statsData = data;
                break;
            }
        } catch (error) {
            console.log(`‚ùå ${endpoint} failed:`, error.message);
        }
    }
    
    // Jika tidak ada endpoint yang berhasil, hitung manual
    if (!statsData) {
        console.log('‚ö†Ô∏è No stats endpoint working, calculating manually...');
        await calculateStatisticsManually();
        return;
    }
    
    // Update stat cards berdasarkan format response
    if (statsData.success && statsData.data) {
        // Format 1: {success: true, data: {total, coffee, nonCoffee, makanan}}
        document.getElementById('totalMenu').textContent = statsData.data.total || 0;
        document.getElementById('totalCoffee').textContent = statsData.data.coffee || 0;
        document.getElementById('totalNonCoffee').textContent = statsData.data.nonCoffee || 0;
        document.getElementById('totalFood').textContent = statsData.data.makanan || 0;
    } else if (statsData.total !== undefined) {
        // Format 2: {total: X}
        document.getElementById('totalMenu').textContent = statsData.total || 0;
        // Untuk lainnya, kita hitung dari data menu nanti
    } else {
        console.log('‚ö†Ô∏è Unknown stats format, calculating manually...');
        await calculateStatisticsManually();
    }
}

// Fungsi untuk menghitung statistik secara manual
async function calculateStatisticsManually() {
    try {
        const response = await fetch('/api/menu');
        if (!response.ok) throw new Error('Failed to fetch menu data');
        
        const menuData = await response.json();
        console.log('Calculating stats from', menuData.length, 'items');
        
        let total = 0;
        let coffee = 0;
        let nonCoffee = 0;
        let makanan = 0;
        
        if (Array.isArray(menuData)) {
            menuData.forEach(item => {
                total++;
                if (item.kategori === 'coffee') {
                    coffee++;
                } else if (item.kategori === 'non-coffee') {
                    nonCoffee++;
                } else if (item.kategori === 'makanan') {
                    makanan++;
                }
            });
        }
        
        document.getElementById('totalMenu').textContent = total;
        document.getElementById('totalCoffee').textContent = coffee;
        document.getElementById('totalNonCoffee').textContent = nonCoffee;
        document.getElementById('totalFood').textContent = makanan;
        
    } catch (error) {
        console.error('Error calculating stats manually:', error);
        // Set default values
        document.getElementById('totalMenu').textContent = '0';
        document.getElementById('totalCoffee').textContent = '0';
        document.getElementById('totalNonCoffee').textContent = '0';
        document.getElementById('totalFood').textContent = '0';
    }
}

// ==================== FUNGSI LOAD MENU DATA ====================
async function loadMenuData() {
    console.log('üìã Loading menu data...');
    
    try {
        const response = await fetch('/api/menu');
        
        if (!response.ok) {
            throw new Error(`Menu API error: ${response.status}`);
        }
        
        const menuData = await response.json();
        console.log('Menu data received:', menuData);
        
        // Hide loading
        document.getElementById('menuLoading').style.display = 'none';
        
        if (menuData && menuData.length > 0) {
            document.getElementById('menuTableContainer').style.display = 'block';
            document.getElementById('menuEmpty').style.display = 'none';
            updateRecentMenuTable(menuData);
        } else {
            document.getElementById('menuEmpty').style.display = 'block';
            document.getElementById('menuTableContainer').style.display = 'none';
        }
        
        return menuData;
        
    } catch (error) {
        console.error('‚ùå Error loading menu data:', error);
        
        document.getElementById('menuLoading').innerHTML = `
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c; margin-bottom: 20px;"></i>
                <h3 style="color: #e74c3c; margin-bottom: 10px;">Gagal Memuat Data Menu</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">${error.message}</p>
                <button onclick="loadDashboardData()" class="btn" style="background: #3498db;">
                    <i class="fas fa-redo"></i> Coba Lagi
                </button>
            </div>
        `;
        
        throw error;
    }
}

// ==================== FUNGSI UTAMA LOAD DASHBOARD ====================
async function loadDashboardData() {
    console.log('üîÑ Loading dashboard data...');
    updateApiStatus('loading', 'Loading data...');
    
    try {
        // Test koneksi dulu
        const isConnected = await testConnection();
        if (!isConnected) {
            throw new Error('Cannot connect to API server');
        }
        
        // Load statistik dan menu data secara paralel
        await Promise.all([
            loadStatistics(),
            loadMenuData()
        ]);
        
        updateApiStatus('online');
        hideConnectionError();
        
    } catch (error) {
        console.error('‚ùå Error loading dashboard data:', error);
        
        showConnectionError(error.message);
        updateApiStatus('offline');
        
        // Fallback: Coba load menu data saja
        try {
            await loadMenuData();
        } catch (menuError) {
            console.error('Fallback also failed:', menuError);
        }
    }
}

function updateRecentMenuTable(menus) {
    const tbody = document.getElementById('menuTableBody');
    tbody.innerHTML = '';
    
    if (!Array.isArray(menus) || menus.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; padding: 30px;">
                    <i class="fas fa-utensils" style="font-size: 48px; color: #95a5a6;"></i>
                    <p style="color: #7f8c8d; margin-top: 10px;">Belum ada data menu</p>
                </td>
            </tr>
        `;
        return;
    }
    
    // Get last 5 items
    const recentMenus = menus.slice(-5).reverse();
    
    recentMenus.forEach(menu => {
        const row = document.createElement('tr');
        
        // Format harga
        const price = new Intl.NumberFormat('id-ID', {
            style: 'currency',
            currency: 'IDR',
            minimumFractionDigits: 0
        }).format(menu.harga || 0);
        
        // Category badge
        let badgeClass = 'badge-coffee';
        let categoryText = 'Coffee';
        
        if (menu.kategori === 'non-coffee') {
            badgeClass = 'badge-non-coffee';
            categoryText = 'Non-Coffee';
        } else if (menu.kategori === 'makanan') {
            badgeClass = 'badge-makanan';
            categoryText = 'Makanan';
        }
        
        row.innerHTML = `
            <td>
                <strong>${menu.nama_menu || 'Unnamed'}</strong>
                ${menu.deskripsi ? `<br><small class="text-muted">${menu.deskripsi.substring(0, 50)}${menu.deskripsi.length > 50 ? '...' : ''}</small>` : ''}
            </td>
            <td><strong>${price}</strong></td>
            <td><span class="badge ${badgeClass}">${categoryText}</span></td>
            <td>
                <button onclick="editMenu(${menu.id})" class="btn btn-sm" style="background: #3498db; padding: 5px 10px;">
                    <i class="fas fa-edit"></i> Edit
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function editMenu(id) {
    window.location.href = `/admin/menu.html?edit=${id}`;
}

// ==================== INITIALIZE ====================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Dashboard initialized');
    console.log('üìç Current URL:', window.location.href);
    
    // Set username
    try {
        const auth = JSON.parse(localStorage.getItem('adminAuth') || '{}');
        if (auth.username) {
            document.getElementById('adminUsername').textContent = auth.username;
        }
    } catch (e) {
        console.log('Auth data not available');
    }
    
    // Load dashboard data
    loadDashboardData();
    
    // Auto refresh every 30 seconds
    setInterval(loadDashboardData, 30000);
    
    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Yakin ingin logout?')) {
            localStorage.removeItem('adminAuth');
            window.location.href = '/login.html';
        }
    });
    
    // Debug button for development
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        const debugBtn = document.createElement('button');
        debugBtn.innerHTML = '<i class="fas fa-bug"></i> Debug';
        debugBtn.style.cssText = `
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1000;
            font-size: 12px;
        `;
        debugBtn.onclick = async function() {
            console.log('=== DEBUG INFO ===');
            console.log('Current URL:', window.location.href);
            
            // Test semua endpoint
            const endpoints = [
                '/api/test',
                '/api/menu',
                '/api/menu/stats',
                '/api/menu-statistics',
                '/api/menu/count'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    console.log(`Testing: ${endpoint}`);
                    const response = await fetch(endpoint);
                    const data = await response.json();
                    console.log(`${endpoint}:`, data);
                } catch (error) {
                    console.error(`${endpoint} error:`, error.message);
                }
            }
        };
        document.body.appendChild(debugBtn);
    }
});

// Expose functions to window
window.testConnection = testConnection;
window.loadDashboardData = loadDashboardData;
</script>
</body>
</html>