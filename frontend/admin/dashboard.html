<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Kopi Nusantara</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/admin.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Backup styles jika CSS tidak load */
        .admin-container { display: flex; min-height: 100vh; }
        .admin-sidebar { width: 250px; background: #2c3e50; color: white; }
        .admin-main { flex: 1; padding: 20px; }
        .dashboard-content { max-width: 1200px; margin: 0 auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; align-items: center; }
        .stat-icon { width: 60px; height: 60px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 15px; color: white; font-size: 24px; }
        .dashboard-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        .btn { display: inline-block; padding: 10px 20px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; }
        .btn-primary { background: #2ecc71; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 12px; color: white; }
        .badge-coffee { background: #e74c3c; }
        .badge-non-coffee { background: #3498db; }
        .badge-makanan { background: #2ecc71; }
        .loading { text-align: center; padding: 40px; color: #7f8c8d; }
        .text-muted { color: #7f8c8d; }
        .empty-state { text-align: center; padding: 40px; }
        .table-responsive { overflow-x: auto; }
        .quick-actions { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
        .action-card { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; text-decoration: none; color: #333; transition: transform 0.3s; }
        .action-card:hover { transform: translateY(-5px); background: #e9ecef; }
        .action-card i { font-size: 24px; margin-bottom: 10px; display: block; color: #3498db; }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-coffee"></i> Kopi Nusantara</h2>
                <p>Admin Panel</p>
            </div>
            <nav class="sidebar-nav">
                <a href="/admin/dashboard.html" class="active">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="/admin/menu.html">
                    <i class="fas fa-utensils"></i> Kelola Menu
                </a>
                <a href="/admin/orders.html">
                    <i class="fas fa-shopping-cart"></i> Pesanan
                </a>
                <a href="/index.html" target="_blank">
                    <i class="fas fa-home"></i> Lihat Website
                </a>
                <a href="#" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="admin-main">
            <header class="admin-header">
                <h1>Dashboard Admin</h1>
                <div class="admin-user">
                    <span id="adminUsername">Admin</span>
                    <span class="badge badge-coffee">Admin</span>
                </div>
            </header>

            <div class="dashboard-content">
                <!-- Stats Cards -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #4CAF50;">
                            <i class="fas fa-utensils"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalMenu">0</h3>
                            <p>Total Menu</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #2196F3;">
                            <i class="fas fa-coffee"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalCoffee">0</h3>
                            <p>Menu Coffee</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #FF9800;">
                            <i class="fas fa-glass-whiskey"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalNonCoffee">0</h3>
                            <p>Non-Coffee</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon" style="background: #9C27B0;">
                            <i class="fas fa-hamburger"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="totalFood">0</h3>
                            <p>Menu Makanan</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Menu Table -->
                <div class="dashboard-card">
                    <div class="card-header">
                        <h2><i class="fas fa-list"></i> Menu Terbaru</h2>
                        <a href="/admin/menu.html" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Tambah Menu
                        </a>
                    </div>
                    
                    <div id="menuLoading" class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Memuat data menu...</p>
                    </div>
                    
                    <div id="menuTableContainer" style="display: none;">
                        <div class="table-responsive">
                            <table class="table" id="recentMenuTable">
                                <thead>
                                    <tr>
                                        <th>Nama Menu</th>
                                        <th>Harga</th>
                                        <th>Kategori</th>
                                        <th>Tanggal Ditambah</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="menuTableBody">
                                    <!-- Data akan diisi oleh JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div id="menuEmpty" class="empty-state" style="display: none;">
                        <i class="fas fa-utensils"></i>
                        <p>Belum ada data menu</p>
                        <a href="/admin/menu.html" class="btn btn-primary">Tambah Menu Pertama</a>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="dashboard-card">
                    <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                    <div class="quick-actions">
                        <a href="/admin/menu.html" class="action-card">
                            <i class="fas fa-plus-circle"></i>
                            <span>Tambah Menu Baru</span>
                        </a>
                        <a href="/admin/orders.html" class="action-card">
                            <i class="fas fa-eye"></i>
                            <span>Lihat Pesanan</span>
                        </a>
                        <a href="/index.html" class="action-card" target="_blank">
                            <i class="fas fa-external-link-alt"></i>
                            <span>Lihat Frontend</span>
                        </a>
                        <a href="/admin/menu.html" class="action-card">
                            <i class="fas fa-edit"></i>
                            <span>Edit Menu</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
    // ==================== KONFIGURASI ====================
    const API_BASE_URL = 'http://localhost:3000';
    
    // ==================== FUNGSI UTAMA ====================
    async function loadDashboardData() {
        console.log('üîÑ Memuat data dashboard...');
        
        try {
            // 1. Test API endpoint dulu
            console.log('üîå Testing API endpoint...');
            const testResponse = await fetch(`${API_BASE_URL}/api/test`);
            
            if (!testResponse.ok) {
                const errorText = await testResponse.text();
                console.error('API Error:', errorText);
                throw new Error(`API Error ${testResponse.status}`);
            }
            
            const testData = await testResponse.json();
            console.log('‚úÖ API Test Response:', testData);
            
            // 2. Load menu statistics
            console.log('üìä Mengambil statistik menu...');
            const statsResponse = await fetch(`${API_BASE_URL}/api/menu/stats`);
            
            if (!statsResponse.ok) {
                throw new Error(`Stats API error: ${statsResponse.status}`);
            }
            
            const statsData = await statsResponse.json();
            console.log('üìà Menu Statistics:', statsData);
            
            // Update stat cards dengan data REAL
            if (statsData.success) {
                document.getElementById('totalMenu').textContent = statsData.data.total || 0;
                document.getElementById('totalCoffee').textContent = statsData.data.coffee || 0;
                document.getElementById('totalNonCoffee').textContent = statsData.data.nonCoffee || 0;
                document.getElementById('totalFood').textContent = statsData.data.makanan || 0;
            }
            
            // 3. Load all menu data (gunakan endpoint yang ada di server)
            console.log('üìã Mengambil semua data menu...');
            const menuResponse = await fetch(`${API_BASE_URL}/api/menu`);
            
            if (!menuResponse.ok) {
                // Fallback: coba endpoint lain
                console.log('Coba endpoint alternatif...');
                const menuResponse2 = await fetch(`${API_BASE_URL}/api/menu/all`);
                if (!menuResponse2.ok) {
                    throw new Error(`Menu API error: ${menuResponse2.status}`);
                }
                var menuData = await menuResponse2.json();
            } else {
                var menuData = await menuResponse.json();
            }
            
            console.log('üçΩÔ∏è Menu Data Received:', menuData);
            
            // Sembunyikan loading
            document.getElementById('menuLoading').style.display = 'none';
            
            // Tampilkan data atau empty state
            if (menuData && menuData.length > 0) {
                document.getElementById('menuTableContainer').style.display = 'block';
                document.getElementById('menuEmpty').style.display = 'none';
                updateRecentMenuTable(menuData);
            } else {
                document.getElementById('menuTableContainer').style.display = 'none';
                document.getElementById('menuEmpty').style.display = 'block';
                console.log('‚ÑπÔ∏è Tidak ada data menu');
            }
            
        } catch (error) {
            console.error('‚ùå Dashboard Error:', error);
            showDetailedError(error);
        }
    }
    
    function showDetailedError(error) {
        const errorHTML = `
            <div style="text-align: center; padding: 30px;">
                <i class="fas fa-unlink" style="font-size: 64px; color: #e74c3c; margin-bottom: 20px;"></i>
                <h3 style="color: #e74c3c; margin-bottom: 10px;">Koneksi API Gagal</h3>
                <p style="color: #7f8c8d; margin-bottom: 20px;">
                    <strong>Error:</strong> ${error.message}
                </p>
                
                <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px;">
                    <button onclick="testEndpoint('${API_BASE_URL}/api/test')" class="btn" style="background: #3498db;">
                        <i class="fas fa-plug"></i> Test /api/test
                    </button>
                    <button onclick="testEndpoint('${API_BASE_URL}/health')" class="btn" style="background: #2ecc71;">
                        <i class="fas fa-heartbeat"></i> Test /health
                    </button>
                    <button onclick="testEndpoint('${API_BASE_URL}/api/menu')" class="btn" style="background: #9b59b6;">
                        <i class="fas fa-utensils"></i> Test /api/menu
                    </button>
                    <button onclick="loadDashboardData()" class="btn" style="background: #f39c12;">
                        <i class="fas fa-redo"></i> Coba Lagi
                    </button>
                </div>
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; text-align: left;">
                    <h5><i class="fas fa-wrench"></i> Langkah Perbaikan:</h5>
                    <ol>
                        <li>Pastikan server backend berjalan</li>
                        <li>Buka <a href="${API_BASE_URL}/api/test" target="_blank">${API_BASE_URL}/api/test</a> di tab baru</li>
                        <li>Jika error, restart server dengan <code>npm start</code></li>
                        <li>Pastikan endpoint /api/test ada di server.js</li>
                    </ol>
                </div>
            </div>
        `;
        
        document.getElementById('menuLoading').innerHTML = errorHTML;
    }
    
    async function testEndpoint(url) {
        try {
            const response = await fetch(url);
            const data = await response.json();
            
            const result = `
                <strong>URL:</strong> ${url}<br>
                <strong>Status:</strong> <span style="color: ${response.ok ? 'green' : 'red'}">${response.status} ${response.statusText}</span><br>
                <strong>Response:</strong><br>
                <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; max-height: 200px; overflow: auto;">${JSON.stringify(data, null, 2)}</pre>
            `;
            
            alertDialog('Test Result', result);
            
        } catch (error) {
            alertDialog('Test Failed', `
                <strong>URL:</strong> ${url}<br>
                <strong>Error:</strong> ${error.message}<br>
                <strong>Detail:</strong> ${error}
            `);
        }
    }
    
    function alertDialog(title, content) {
        const dialog = document.createElement('div');
        dialog.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 9999; display: flex;
            justify-content: center; align-items: center;
        `;
        
        dialog.innerHTML = `
            <div style="background: white; border-radius: 10px; padding: 20px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">${title}</h4>
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                </div>
                <div>${content}</div>
                <div style="margin-top: 15px; text-align: center;">
                    <button onclick="this.parentElement.parentElement.parentElement.remove()" class="btn" style="background: #6c757d;">Tutup</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(dialog);
    }
    
    function updateRecentMenuTable(menus) {
        const tbody = document.getElementById('menuTableBody');
        tbody.innerHTML = '';
        
        // Sort by date (newest first) and take 5
        const recentMenus = [...menus]
            .sort((a, b) => {
                const dateA = new Date(a.created_at || '2000-01-01');
                const dateB = new Date(b.created_at || '2000-01-01');
                return dateB - dateA;
            })
            .slice(0, 5);
        
        if (recentMenus.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px;">
                        <i class="fas fa-utensils" style="font-size: 48px; color: #95a5a6;"></i>
                        <p style="color: #7f8c8d; margin-top: 10px;">Belum ada data menu</p>
                    </td>
                </tr>
            `;
            return;
        }
        
        recentMenus.forEach(menu => {
            const row = document.createElement('tr');
            
            // Format harga
            const price = new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR'
            }).format(menu.harga || 0);
            
            // Format tanggal
            let date = 'N/A';
            if (menu.created_at) {
                date = new Date(menu.created_at).toLocaleDateString('id-ID', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            }
            
            // Category badge
            let badgeClass = 'badge-coffee';
            let categoryText = menu.kategori || 'unknown';
            
            if (menu.kategori === 'non-coffee') {
                badgeClass = 'badge-non-coffee';
                categoryText = 'Non-Coffee';
            } else if (menu.kategori === 'makanan') {
                badgeClass = 'badge-makanan';
                categoryText = 'Makanan';
            } else if (menu.kategori === 'coffee') {
                categoryText = 'Coffee';
            }
            
            row.innerHTML = `
                <td>
                    <strong>${menu.nama_menu || 'Unnamed'}</strong>
                    ${menu.deskripsi ? `<br><small class="text-muted">${menu.deskripsi.substring(0, 50)}${menu.deskripsi.length > 50 ? '...' : ''}</small>` : ''}
                </td>
                <td><strong>${price}</strong></td>
                <td><span class="badge ${badgeClass}">${categoryText}</span></td>
                <td>${date}</td>
                <td>
                    <button onclick="editMenu(${menu.id})" class="btn btn-sm" style="background: #3498db; padding: 5px 10px;">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }
    
    function editMenu(id) {
        alert(`Edit menu ID: ${id}`);
        window.location.href = `/admin/menu.html?edit=${id}`;
    }
    
    // ==================== INITIALIZE ====================
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üìä Dashboard initialized');
        
        // Simple auth
        if (!localStorage.getItem('adminAuth')) {
            localStorage.setItem('adminAuth', JSON.stringify({
                username: 'Admin Kopi Nusantara',
                isLoggedIn: true,
                role: 'admin'
            }));
        }
        
        // Set username
        try {
            const auth = JSON.parse(localStorage.getItem('adminAuth'));
            document.getElementById('adminUsername').textContent = `Selamat datang, ${auth.username}`;
        } catch (e) {
            document.getElementById('adminUsername').textContent = 'Admin';
        }
        
        // Load data
        loadDashboardData();
        
        // Auto refresh
        setInterval(loadDashboardData, 30000);
        
        // Logout
        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('Yakin ingin logout?')) {
                localStorage.removeItem('adminAuth');
                window.location.href = '/login';
            }
        });
    });
</script>
</body>
</html>